{"version":3,"sources":["localResize.coffee"],"names":[],"mappings":"AAAA;AAAA;;;;;;;;GAAA;AAAA;AAAA;AAAA,MAAA,WAAA;;AAAA,EASM;AACS,IAAA,qBAAC,EAAD,EAAK,OAAL,GAAA;AACX,UAAA,IAAA;;QADgB,UAAU;OAC1B;AAAA,MAAA,IAAA,CAAA,EAAA;AAAe,eAAO,OAAO,CAAC,KAAR,CAAc,aAAd,CAAP,CAAf;OAAA;AAAA,MAEA,IAAC,CAAA,EAAD,GAAY,EAFZ,CAAA;AAAA,MAGA,IAAC,CAAA,OAAD,GAAY,EAHZ,CAAA;AAAA,MAIA,IAAC,CAAA,QAAD,GACE;AAAA,QAAA,MAAA,EAAU,GAAV;AAAA,QACA,OAAA,EAAU,GADV;AAAA,QAEA,EAAA,EAAU,IAFV;OALF,CAAA;AAUA,WAAA,YAAA;uBAAA;AACE,QAAA,IAAG,CAAH;AAAU,UAAA,IAAC,CAAA,QAAS,CAAA,CAAA,CAAV,GAAe,CAAf,CAAV;SADF;AAAA,OAVA;AAAA,MAcA,IAAC,CAAA,KAAD,CAAA,CAdA,CADW;IAAA,CAAb;;AAkBA;AAAA;;;OAlBA;;AAAA,0BAsBA,MAAA,GAAQ,SAAC,GAAD,GAAA;AACN,MAAA,IAAC,CAAA,EAAE,CAAC,MAAJ,CAAW,GAAX,CAAA,CAAA;AACA,aAAO,IAAP,CAFM;IAAA,CAtBR,CAAA;;AA2BA;AAAA;;;OA3BA;;AAAA,0BA+BA,UAAA,GAAY,SAAC,GAAD,GAAA;AACV,MAAA,IAAC,CAAA,EAAE,CAAC,UAAJ,CAAe,GAAf,CAAA,CAAA;AACA,aAAO,IAAP,CAFU;IAAA,CA/BZ,CAAA;;AAoCA;AAAA;;OApCA;;AAAA,0BAuCA,OAAA,GAAS,SAAA,GAAA;AACP,MAAA,IAAC,CAAA,EAAE,CAAC,UAAJ,CAAA,CAAA,CAAA;AACA,aAAO,IAAP,CAFO;IAAA,CAvCT,CAAA;;AA4CA;AAAA;;OA5CA;;AAAA,0BA+CA,KAAA,GAAO,SAAA,GAAA;AACL,MAAA,IAAC,CAAA,OAAD,GAAW,EAAX,CAAA;AAAA,MACA,IAAC,CAAA,EAAE,CAAC,KAAJ,CAAA,CADA,CAAA;AAEA,aAAO,IAAP,CAHK;IAAA,CA/CP,CAAA;;AAqDA;AAAA;;;OArDA;;AAAA,0BAyDA,MAAA,GAAQ,SAAC,EAAD,GAAA;AACN,MAAA,IAAG,MAAA,CAAA,EAAA,KAAa,UAAhB;AAAgC,QAAA,IAAC,CAAA,MAAD,GAAU,EAAV,CAAhC;OAAA;AACA,aAAO,IAAP,CAFM;IAAA,CAzDR,CAAA;;AA8DA;AAAA;;;;;;;;;;;OA9DA;;AAAA,0BA0EA,OAAA,GAAS,SAAC,EAAD,GAAA;AACP,MAAA,IAAG,MAAA,CAAA,EAAA,KAAa,UAAhB;AAAgC,QAAA,IAAC,CAAA,OAAD,GAAW,EAAX,CAAhC;OAAA;AACA,aAAO,IAAP,CAFO;IAAA,CA1ET,CAAA;;AA+EA;AAAA;;OA/EA;;AAAA,0BAkFA,UAAA,GAAY,SAAA,GAAA;AACV,UAAA,aAAA;AAAA,MAAA,GAAA,GAAM,sNAAN,CAAA;AAAA,MAgBA,QAAA,GAAqB,QAAQ,CAAC,aAAT,CAAuB,OAAvB,CAhBrB,CAAA;AAAA,MAiBA,QAAQ,CAAC,SAAT,GAAqB,GAjBrB,CAAA;AAAA,MAkBA,QAAQ,CAAC,IAAI,CAAC,WAAd,CAA0B,QAA1B,CAlBA,CAAA;aAoBA,WAAW,CAAA,SAAE,CAAA,UAAb,GAA0B,SAAA,GAAA;AAAG,eAAO,IAAP,CAAH;MAAA,EArBhB;IAAA,CAlFZ,CAAA;;AA0GA;AAAA;;OA1GA;;AAAA,0BA6GA,SAAA,GAAW,SAAA,GAAA;AAET,MAAA,IAAC,CAAA,EAAE,CAAC,SAAS,CAAC,GAAd,CAAkB,IAAlB,CAAA,CAAA;AAGA,MAAA,IAAG,IAAC,CAAA,QAAQ,CAAC,EAAb;AAAqB,QAAA,IAAC,CAAA,EAAD,GAAU,IAAA,IAAA,CAAK,IAAL,CAAV,CAArB;OAHA;AAAA,MAMA,IAAC,CAAA,IAAD,GAAa,QAAQ,CAAC,aAAT,CAAuB,OAAvB,CANb,CAAA;AAAA,MAOA,IAAC,CAAA,IAAI,CAAC,IAAN,GAAa,MAPb,CAAA;aAQA,IAAC,CAAA,EAAE,CAAC,WAAJ,CAAgB,IAAC,CAAA,IAAjB,EAVS;IAAA,CA7GX,CAAA;;AA0HA;AAAA;;OA1HA;;AAAA,0BA6HA,UAAA,GAAY,SAAA,GAAA;AAEV,UAAA,UAAA;AAAA,MAAA,IAAC,CAAA,IAAI,CAAC,gBAAN,CAAuB,QAAvB,EAAiC,SAAA,GAAA;AAE/B,QAAA,UAAA,CAAW,IAAC,CAAC,KAAM,CAAA,CAAA,CAAnB,CAAA,CAAA;eAGA,IAAC,CAAC,KAAF,GAAU,GALqB;MAAA,CAAjC,EAME,KANF,CAAA,CAAA;aAQA,UAAA,GAAa,CAAA,SAAA,KAAA,GAAA;eAAA,SAAC,IAAD,GAAA;AACX,cAAA,iCAAA;AAAA,UAAA,GAAA,GAAmB,MAAM,CAAC,GAAP,IAAc,MAAM,CAAC,SAAxC,CAAA;AAAA,UACA,QAAA,GAAmB,KAAC,CAAA,QADpB,CAAA;AAAA,UAEA,OAAA,GAAmB,KAAC,CAAA,OAAD,GAAW,EAF9B,CAAA;AAAA,UAGA,OAAO,CAAC,QAAR,GAAmB,EAHnB,CAAA;AAMA,eAAA,SAAA;wBAAA;AACE,YAAA,IAAG,MAAA,CAAA,CAAA,KAAc,UAAjB;AAAiC,cAAA,OAAO,CAAC,QAAS,CAAA,CAAA,CAAjB,GAAsB,CAAtB,CAAjC;aADF;AAAA,WANA;AAAA,UAcA,OAAO,CAAC,IAAR,GAAe,GAAG,CAAC,eAAJ,CAAoB,IAApB,CAdf,CAAA;AAAA,UAiBA,KAAC,CAAA,MAAD,CAAQ,OAAR,CAjBA,CAAA;AAoBA,UAAA,IAAG,KAAC,CAAA,QAAQ,CAAC,EAAb;AACE,YAAA,KAAC,CAAA,MAAD,CAAQ,OAAO,CAAC,IAAhB,CAAA,CAAA;AAAA,YACA,KAAC,CAAA,EAAE,CAAC,OAAJ,CAAA,CADA,CADF;WApBA;AAAA,UAyBA,GAAA,GAAU,IAAA,KAAA,CAAA,CAzBV,CAAA;AAAA,UA0BA,GAAG,CAAC,GAAJ,GAAU,OAAO,CAAC,IA1BlB,CAAA;iBA4BA,GAAG,CAAC,MAAJ,GAAa,SAAA,GAAA;AAEX,gBAAA,kFAAA;AAAA,YAAA,KAAA,GAAQ,GAAG,CAAC,KAAJ,GAAY,GAAG,CAAC,MAAxB,CAAA;AAAA,YACA,CAAA,GAAQ,QAAQ,CAAC,MAAT,IAAmB,GAAG,CAAC,KAD/B,CAAA;AAAA,YAEA,CAAA,GAAQ,CAAA,GAAI,KAFZ,CAAA;AAAA,YAKA,MAAA,GAAS,QAAQ,CAAC,aAAT,CAAuB,QAAvB,CALT,CAAA;AAAA,YAMA,MAAM,CAAC,KAAP,GAAgB,CANhB,CAAA;AAAA,YAOA,MAAM,CAAC,MAAP,GAAgB,CAPhB,CAAA;AAAA,YASA,GAAA,GAAM,MAAM,CAAC,UAAP,CAAkB,IAAlB,CATN,CAAA;AAAA,YAUA,GAAG,CAAC,SAAJ,CAAc,GAAd,EAAmB,CAAnB,EAAsB,CAAtB,EAAyB,CAAzB,EAA4B,CAA5B,CAVA,CAAA;AAAA,YAaA,SAAA,GAAY,SAAS,CAAC,SAbtB,CAAA;AAAA,YAcA,MAAA,GAAY,IAdZ,CAAA;AAiBA,YAAA,IAAG,SAAS,CAAC,KAAV,CAAgB,SAAhB,CAAH;AACE;AACE,gBAAA,KAAA,GAAY,IAAA,YAAA,CAAa,GAAb,CAAZ,CAAA;AAAA,gBACA,KAAK,CAAC,MAAN,CAAa,MAAb,EACE;AAAA,kBAAA,QAAA,EAAa,CAAb;AAAA,kBACA,SAAA,EAAa,CADb;AAAA,kBAEA,OAAA,EAAa,QAAQ,CAAC,OAFtB;iBADF,CADA,CAAA;AAAA,gBAKA,MAAA,GAAS,MAAM,CAAC,SAAP,CAAiB,YAAjB,EAA+B,QAAQ,CAAC,OAAxC,CALT,CADF;eAAA,cAAA;AAQE,gBADI,UACJ,CAAA;AAAA,gBAAA,KAAA,CAAM,qBAAN,CAAA,CARF;eADF;aAAA,MAYK,IAAG,SAAS,CAAC,KAAV,CAAgB,UAAhB,CAAH;AACH;AACE,gBAAA,OAAA,GAAc,IAAA,WAAA,CAAA,CAAd,CAAA;AAAA,gBACA,MAAA,GAAS,OAAO,CAAC,MAAR,CAAe,GAAG,CAAC,YAAJ,CAAiB,CAAjB,EAAoB,CAApB,EAAuB,CAAvB,EAA0B,CAA1B,CAAf,EAA6C,QAAQ,CAAC,OAAT,GAAmB,GAAhE,CADT,CADF;eAAA,cAAA;AAIE,gBADI,UACJ,CAAA;AAAA,gBAAA,KAAA,CAAM,qBAAN,CAAA,CAJF;eADG;aAAA,MAAA;AASH,cAAA,MAAA,GAAS,MAAM,CAAC,SAAP,CAAiB,YAAjB,EAA+B,QAAQ,CAAC,OAAxC,CAAT,CATG;aA7BL;AAAA,YAyCA,OAAO,CAAC,MAAR,GAAsB,MAzCtB,CAAA;AAAA,YA0CA,OAAO,CAAC,WAAR,GAAsB,MAAM,CAAC,MAAP,CAAc,MAAM,CAAC,OAAP,CAAe,GAAf,CAAA,GAAsB,CAApC,CA1CtB,CAAA;AA6CA,YAAA,IAAO,WAAW,CAAA,SAAE,CAAA,OAAb,KAAwB,KAAC,CAAA,OAAhC;AAEE,cAAA,IAAA,GAAO,KAAP,CAAA;AAAA,cACM;0CACJ;;AAAA,uCAAA,IAAA,GAAM,SAAA,GAAA;yBACJ,IAAI,CAAC,OAAO,CAAC,IAAb,CAAkB,IAAlB,EADI;gBAAA,CAAN,CAAA;;oCAAA;;kBAFF,CAAA;qBAKA,KAAC,CAAA,OAAD,CAAS,GAAA,CAAA,YAAI,CAAA,CAAc,CAAC,IAA5B,EAAkC,OAAlC,EAPF;aA/CW;UAAA,EA7BF;QAAA,EAAA;MAAA,CAAA,CAAA,CAAA,IAAA,EAVH;IAAA,CA7HZ,CAAA;;AAAA,0BA8NA,KAAA,GAAO,SAAA,GAAA;AACL,MAAA,IAAC,CAAA,UAAD,CAAA,CAAA,CAAA;AAAA,MACA,IAAC,CAAA,SAAD,CAAA,CADA,CAAA;aAEA,IAAC,CAAA,UAAD,CAAA,EAHK;IAAA,CA9NP,CAAA;;uBAAA;;MAVF,CAAA;;AAAA,EA+OA,MAAM,CAAC,WAAP,GAAqB,WA/OrB,CAAA;AAAA","file":"localResize.js","sourceRoot":"/source/","sourcesContent":["###*\r\n *  LocalResize\r\n * @class\r\n * @param {Object} el 原生的dom元素\r\n * @param {Object} options={} 可选项\r\n * @param {number} options.rWidth=800 压缩图片的宽度，高度会跟随适应。\r\n * @param {number} options.quality=0.7 压缩质量,取值 0-1\r\n * @param {boolean} options.UI 是否需要内置操作界面\r\n###\r\nclass LocalResize\r\n  constructor: (el, options = {}) ->\r\n    unless el then return console.error '需要传入一个dom元素'\r\n\r\n    @el       = el\r\n    @results  = {}\r\n    @defaults =\r\n      rWidth  : 800\r\n      quality : 0.7\r\n      UI      : true\r\n\r\n\r\n    for k, v of options\r\n      if v then @defaults[k] = v\r\n\r\n\r\n    @_init()\r\n\r\n\r\n  ###*\r\n   * 设置预览图片\r\n   * @param {string} url \r\n  ###\r\n  setImg: (url) ->\r\n    @UI.setImg url\r\n    return @\r\n\r\n\r\n  ###*\r\n   * 设置预览图片-无删除图标\r\n   * @param {string} url \r\n  ###\r\n  setImgOnly: (url) ->\r\n    @UI.setImgOnly url\r\n    return @\r\n\r\n\r\n  ###*\r\n   * @description 停止加载状态，通常在ajax完成后调用。\r\n  ###\r\n  setStop: ->\r\n    @UI.setSuccess()\r\n    return @\r\n\r\n\r\n  ###*\r\n   * 恢复初始状态\r\n  ###\r\n  reset: ->\r\n    @results = {}\r\n    @UI.reset()\r\n    return @\r\n\r\n\r\n  ###*\r\n   * change回调\r\n   * @param  {function} fn \r\n  ###\r\n  change: (fn) ->\r\n    if typeof fn is 'function' then @change = fn\r\n    return @\r\n\r\n\r\n  ###*\r\n   * success回调\r\n   *\r\n   * @example\r\n   * lr.success(function(stop, data{});\r\n   * \r\n   * @param {function} stop 停止加载状态\r\n   * @param {function} data data.base64 生成好的base64文件\r\n   *                        data.base64Clean 清除头信息的base64，方便后端存为图片\r\n   *                        data.original 原始文件的信息，例如type name size\r\n   * \r\n  ###\r\n  success: (fn) ->\r\n    if typeof fn is 'function' then @success = fn\r\n    return @\r\n\r\n\r\n  ###*\r\n   * 初始化样式\r\n  ###\r\n  _initStyle: ->\r\n    css = \"\"\"\r\n        .lr {\r\n          position: relative;\r\n          display: inline-block;\r\n        }\r\n\r\n        .lr input[type=file] {\r\n            width: 100%;\r\n            height: 100%;\r\n            position: absolute;\r\n            top: 0;\r\n            left: 0;\r\n            z-index: 1991;\r\n            opacity: 0;\r\n        }\r\n        \"\"\"\r\n    theStyle           = document.createElement 'style'\r\n    theStyle.innerHTML = css\r\n    document.head.appendChild theStyle\r\n\r\n    LocalResize::_initStyle = -> return true\r\n\r\n\r\n  ###*\r\n   * 生成元素\r\n  ###\r\n  _createEl: ->\r\n    # 生成基本样式\r\n    @el.classList.add 'lr'\r\n\r\n    # 生成UI\r\n    if @defaults.UI then @UI = new LrUI @\r\n\r\n    # 生成上传控件\r\n    @file      = document.createElement 'input'\r\n    @file.type = 'file'\r\n    @el.appendChild @file\r\n\r\n\r\n  ###*\r\n   * 获取base64\r\n  ###\r\n  _getBase64: ->\r\n    # 监听变化\r\n    @file.addEventListener 'change', ->\r\n      # 获取base64\r\n      getResults @.files[0]\r\n\r\n      # 打扫卫生\r\n      @.value = ''\r\n    , false\r\n\r\n    getResults = (file) =>\r\n      URL              = window.URL or window.webkitURL\r\n      defaults         = @defaults\r\n      results          = @results = {}\r\n      results.original = {}\r\n\r\n      # 生成原始数据\r\n      for k, v of file\r\n        if typeof v isnt 'function' then results.original[k] = v\r\n\r\n      # 拒绝非图片\r\n      # 部分手机没有提供type参数（微信环境），例如小米2。\r\n#      unless /(gif|jpg|jpeg|png|GIF|JPG|PNG|tiff|raw|exif|bmp)$/.test file.type then return alert '不是标准的图片，请您重试。'\r\n\r\n      # 生成引用\r\n      results.blob = URL.createObjectURL file\r\n\r\n      # change回调\r\n      @change results\r\n\r\n      # 生成预览\r\n      if @defaults.UI\r\n        @setImg results.blob\r\n        @UI.setWait()\r\n\r\n      # 生成base64\r\n      img = new Image()\r\n      img.src = results.blob\r\n\r\n      img.onload = =>\r\n        # 计算缩放尺寸\r\n        scale = img.width / img.height\r\n        w     = defaults.rWidth or img.width\r\n        h     = w / scale\r\n\r\n        # 创建canvas\r\n        canvas = document.createElement 'canvas'\r\n        canvas.width  = w\r\n        canvas.height = h\r\n\r\n        ctx = canvas.getContext '2d'\r\n        ctx.drawImage img, 0, 0, w, h\r\n\r\n        # 兼容各种环境\r\n        userAgent = navigator.userAgent\r\n        base64    = null\r\n\r\n        # 兼容 IOS\r\n        if userAgent.match /iphone/i\r\n          try\r\n            mpImg = new MegaPixImage img\r\n            mpImg.render canvas,\r\n              maxWidth   : w\r\n              maxHeight  : h\r\n              quality    : defaults.quality\r\n            base64 = canvas.toDataURL 'image/jpeg', defaults.quality\r\n          catch e\r\n            alert '未引用mobile补丁，无法生成图片。'\r\n\r\n        # 兼容 Android\r\n        else if userAgent.match /Android/i\r\n          try\r\n            encoder = new JPEGEncoder()\r\n            base64 = encoder.encode ctx.getImageData(0, 0, w, h), defaults.quality * 100\r\n          catch e\r\n            alert '未引用mobile补丁，无法生成图片。'\r\n\r\n        # 其他情况\r\n        else\r\n          base64 = canvas.toDataURL 'image/jpeg', defaults.quality\r\n\r\n        # 保存base64\r\n        results.base64      = base64\r\n        results.base64Clean = base64.substr base64.indexOf(',') + 1\r\n\r\n        # success回调\r\n        unless LocalResize::success is @success\r\n          # 停止加载状态的传参，以class的方式解决上下文作用域的问题\r\n          that = @\r\n          class temp_setStop\r\n            stop: ->\r\n              that.setStop.call that\r\n\r\n          @success new temp_setStop().stop, results\r\n\r\n\r\n\r\n  _init: ->\r\n    @_initStyle()\r\n    @_createEl()\r\n    @_getBase64()\r\n\r\n\r\n# 开放接口\r\nwindow.LocalResize = LocalResize\r\n\r\n"]}